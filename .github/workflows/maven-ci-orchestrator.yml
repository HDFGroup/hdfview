name: Maven CI Pipeline

on:
  push:
    branches: [ master, master-maven, develop, main ]
  pull_request:
    branches: [ master, master-maven, develop, main ]
  workflow_dispatch:

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  ci-linux:
    name: CI - Linux
    uses: ./.github/workflows/ci-linux.yml
    permissions:
      contents: read
      checks: write
      pull-requests: write

  ci-windows:
    name: CI - Windows
    uses: ./.github/workflows/ci-windows.yml
    permissions:
      contents: read
      checks: write
      pull-requests: write

  ci-macos:
    name: CI - macOS
    uses: ./.github/workflows/ci-macos.yml
    permissions:
      contents: read
      checks: write
      pull-requests: write

  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [ci-linux, ci-windows, ci-macos]
    if: always()

    steps:
    - name: Check Results
      run: |
        echo "## CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Linux    | ${{ needs.ci-linux.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Windows  | ${{ needs.ci-windows.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| macOS    | ${{ needs.ci-macos.result }} |" >> $GITHUB_STEP_SUMMARY

        # Fail if any platform failed
        if [ "${{ needs.ci-linux.result }}" != "success" ] || \
           [ "${{ needs.ci-windows.result }}" != "success" ] || \
           [ "${{ needs.ci-macos.result }}" != "success" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "❌ One or more platforms failed" >> $GITHUB_STEP_SUMMARY
          exit 1
        else
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ All platforms passed" >> $GITHUB_STEP_SUMMARY
        fi
