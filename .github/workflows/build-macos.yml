name: Build MacOS Release Artifacts

on:
    workflow_call:
        inputs:
            artifact_basename:
              description: 'Base name for all build artifacts (e.g., hdfview-master-abc1234 or HDFView-3.4.0)'
              type: string
              required: true
            build_type:
              description: 'Build type: release or snapshot'
              type: string
              required: false
              default: 'snapshot'
            hdf4_release_tag:
              description: 'HDF4 GitHub release tag to download from (e.g., snapshot, hdf4.3.1)'
              type: string
              required: false
              default: 'snapshot'
            hdf4_artifact_basename:
              description: 'HDF4 artifact base filename pattern (e.g., hdf4.3.1, hdf-master-abc1234)'
              type: string
              required: false
              default: 'snapshot'
            hdf5_release_tag:
              description: 'HDF5 GitHub release tag to download from (e.g., snapshot, 2.0.0)'
              type: string
              required: false
              default: 'snapshot'
            hdf5_artifact_basename:
              description: 'HDF5 artifact base filename pattern (e.g., 2.0.0, hdf5-develop-xyz7890)'
              type: string
              required: false
              default: 'snapshot'
            hdf4_version:
              description: 'HDF4 version number (e.g., 4.3.1) - if provided, skips parsing from JAR filename'
              type: string
              required: false
              default: ''
            hdf5_version:
              description: 'HDF5 version number (e.g., 2.0.0) - if provided, skips parsing from JAR filename'
              type: string
              required: false
              default: ''
            hdf5_prefix:
              description: 'Prefix for HDF5 release file patterns: "" for snapshot, "hdf5-" for tagged releases'
              type: string
              required: false
              default: ''
  
permissions:
  contents: read
  packages: write

jobs:
    build-macos-app:
        name: Build macOS App Image (${{ matrix.arch }})
        runs-on: ${{ matrix.runner }}
        timeout-minutes: 45
        strategy:
          matrix:
            include:
              - arch: x86_64
                runner: macos-15-intel
                swt_artifact_id: org.eclipse.swt.cocoa.macosx.x86_64
              - arch: arm64
                runner: macos-15
                swt_artifact_id: org.eclipse.swt.cocoa.macosx.aarch64
        env:
          KEYCHAIN_NAME: ${{ vars.KEYCHAIN_NAME }}
          SIGNER: ${{ vars.SIGNER }}
          NOTARY_USER: ${{ vars.NOTARY_USER }}
          NOTARY_KEY: ${{ vars.NOTARY_KEY }}
          APPLE_CERTS_BASE64: ${{ secrets.APPLE_CERTS_BASE64 }}
          APPLE_CERTS_BASE64_PASSWD: ${{ secrets.APPLE_CERTS_BASE64_PASSWD }}
          KEYCHAIN_PASSWD: ${{ secrets.KEYCHAIN_PASSWD }}

        steps:
        - name: Checkout Code
          uses: actions/checkout@v4
          with:
            fetch-depth: 0

        - name: Extract version from VERSION file
          id: get-version
          run: |
            HDFVIEW_VERSION=$(grep "^HDFVIEW_VERSION=" VERSION | cut -d'=' -f2)
            echo "HDFVIEW_VERSION=$HDFVIEW_VERSION" >> $GITHUB_OUTPUT
            echo "HDFView version: $HDFVIEW_VERSION"

        - name: Set up JDK 21
          uses: actions/setup-java@v4
          with:
            java-version: '21'
            distribution: 'temurin'

        - name: Cache Maven Dependencies
          uses: actions/cache@v4
          with:
            path: |
              ~/.m2/repository
              !~/.m2/repository/org/hdfgroup
            key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
            restore-keys: |
              ${{ runner.os }}-maven-

        - name: Download and Install HDF4 from GitHub
          run: |
            echo "Downloading HDF4 from release tag: ${{ inputs.hdf4_release_tag }}"

            # Determine file pattern based on whether base name is provided
            if [ -n "${{ inputs.hdf4_artifact_basename }}" ]; then
              PATTERN="${{ inputs.hdf4_artifact_basename }}-macos14_clang.tar.gz"
            else
              PATTERN="*-macos14_clang.tar.gz"
            fi
            echo "Using pattern: $PATTERN"

            gh release download "${{ inputs.hdf4_release_tag }}" --repo HDFGroup/hdf4 --pattern "$PATTERN" \
              --clobber
            tar -zxvf *-macos14_clang.tar.gz
            [ -d hdf4 ] || mv hdf4-* hdf4
            cd hdf4
            tar -zxvf HDF-*-Darwin.tar.gz --strip-components 1
            HDF4DIR=${{ github.workspace }}/hdf4/HDF_Group/HDF/
            FILE_NAME=$(ls $HDF4DIR)
            echo "HDF4LIB_PATH=$HDF4DIR$FILE_NAME" >> $GITHUB_ENV
          env:
            GH_TOKEN: ${{ github.token }}

        - name: Download and Install HDF5 from GitHub
          run: |
            echo "Downloading HDF5 from release tag: ${{ inputs.hdf5_release_tag }}"

            # Determine file pattern based on whether base name is provided
            if [ -n "${{ inputs.hdf5_artifact_basename }}" ]; then
              PATTERN="${{ inputs.hdf5_prefix }}${{ inputs.hdf5_artifact_basename }}-macos14_clang.tar.gz"
            else
              PATTERN="hdf5-*-macos14_clang.tar.gz"
            fi
            echo "Using pattern: $PATTERN"

            gh release download "${{ inputs.hdf5_release_tag }}" --repo HDFGroup/hdf5 --pattern "$PATTERN" \
              --clobber
            tar -zxvf hdf5-*-macos14_clang.tar.gz
            [ -d hdf5 ] || mv hdf5-* hdf5
            cd hdf5
            tar -zxvf HDF5-*-Darwin.tar.gz --strip-components 1
            HDF5DIR=${{ github.workspace }}/hdf5/HDF_Group/HDF5/
            FILE_NAME=$(ls $HDF5DIR)
            echo "HDF5LIB_PATH=$HDF5DIR$FILE_NAME" >> $GITHUB_ENV
          env:
            GH_TOKEN: ${{ github.token }}

        - name: Set up build.properties
          run: |
            cat > build.properties <<EOF
            hdf5.lib.dir=${{ env.HDF5LIB_PATH }}/lib
            hdf5.plugin.dir=${{ env.HDF5LIB_PATH }}/lib/plugin
            hdf.lib.dir=${{ env.HDF4LIB_PATH }}/lib
            platform.hdf.lib=${{ env.HDF5LIB_PATH }}/lib
            EOF

        - name: Install HDF JARs to Local Maven Repository
          run: |
            mkdir -p repository/lib
            cp ${{ env.HDF4LIB_PATH }}/lib/*.jar repository/lib/ 2>/dev/null || echo "No HDF4 JARs"
            cp ${{ env.HDF5LIB_PATH }}/lib/*.jar repository/lib/ 2>/dev/null || echo "No HDF5 JARs"
            cp lib/fits.jar repository/lib/ 2>/dev/null || echo "fits.jar not found"
            cp lib/netcdf.jar repository/lib/ 2>/dev/null || echo "netcdf.jar not found"
            if [ -f repository/lib/jarhdf5-*.jar ]; then
              JAR_FILE=$(ls repository/lib/jarhdf5-*.jar | head -1)
              HDF5_VERSION=$(echo "$JAR_FILE" | sed -n 's/.*jarhdf5-\([0-9.]*\)\.jar/\1/p')
              mvn install:install-file -Dfile="$JAR_FILE" -DgroupId=jarhdf5 -DartifactId=jarhdf5 -Dversion="$HDF5_VERSION" -Dpackaging=jar -DgeneratePom=true
              echo "Installed: $JAR_FILE as version $HDF5_VERSION"
              echo "HDF5_VERSION=$HDF5_VERSION" >> $GITHUB_ENV
            fi
            if [ -f repository/lib/jarhdf-*.jar ]; then
              JAR_FILE=$(ls repository/lib/jarhdf-*.jar | head -1)
              HDF4_VERSION=$(echo "$JAR_FILE" | sed -n 's/.*jarhdf-\([0-9.]*\)\.jar/\1/p')
              mvn install:install-file -Dfile="$JAR_FILE" -DgroupId=jarhdf -DartifactId=jarhdf -Dversion="$HDF4_VERSION" -Dpackaging=jar -DgeneratePom=true
              echo "Installed: $JAR_FILE as version $HDF4_VERSION"
              echo "HDF4_VERSION=$HDF4_VERSION" >> $GITHUB_ENV
            fi
            if [ -f repository/lib/fits.jar ]; then
              mvn install:install-file -Dfile=repository/lib/fits.jar \
                -DgroupId=fits -DartifactId=fits -Dversion=1.0.0 -Dpackaging=jar -DgeneratePom=true
            fi
            if [ -f repository/lib/netcdf.jar ]; then
              mvn install:install-file -Dfile=repository/lib/netcdf.jar \
                -DgroupId=netcdf -DartifactId=netcdf -Dversion=1.0.0 -Dpackaging=jar -DgeneratePom=true
            fi

        - name: Build repository module (copies platform SWT JAR)
          run: |
            echo "Building repository module to copy SWT JAR..."
            mvn generate-sources -pl repository -B

        - name: Install SWT JAR to Local Maven Repository
          run: |
            echo "Installing macOS ${{ matrix.arch }} SWT JAR to local Maven repository..."
            if [ -f repository/lib/swt.jar ]; then
              mvn install:install-file -Dfile=repository/lib/swt.jar \
                -DgroupId=org.eclipse.platform \
                -DartifactId=${{ matrix.swt_artifact_id }} \
                -Dversion=3.126.0 \
                -Dpackaging=jar \
                -DgeneratePom=true
              echo "macOS ${{ matrix.arch }} SWT JAR installed"
            else
              echo "ERROR: swt.jar not found in repository/lib/"
              exit 1
            fi

        - name: Install SWTBot JARs to Local Maven Repository
          run: |
            echo "Installing SWTBot JARs to local Maven repository..."

            if [ -f repository/lib/org.eclipse.swtbot.swt.finder.jar ]; then
              mvn install:install-file -Dfile=repository/lib/org.eclipse.swtbot.swt.finder.jar \
                -DgroupId=org.eclipse.local \
                -DartifactId=org.eclipse.swtbot.swt.finder \
                -Dversion=4.2.1 \
                -Dpackaging=jar \
                -DgeneratePom=true
              echo "SWTBot SWT finder JAR installed"
            else
              echo "WARNING: org.eclipse.swtbot.swt.finder.jar not found"
            fi

            if [ -f repository/lib/org.eclipse.swtbot.nebula.nattable.finder.jar ]; then
              mvn install:install-file -Dfile=repository/lib/org.eclipse.swtbot.nebula.nattable.finder.jar \
                -DgroupId=org.eclipse.local \
                -DartifactId=org.eclipse.swtbot.nebula.nattable.finder \
                -Dversion=4.2.1 \
                -Dpackaging=jar \
                -DgeneratePom=true
              echo "SWTBot Nebula NatTable finder JAR installed"
            else
              echo "WARNING: org.eclipse.swtbot.nebula.nattable.finder.jar not found"
            fi

        - name: Build and Package Application
          run: |
            echo "Building HDFView with Maven..."
            mvn install -B -N -Ddependency-check.skip=true
            mvn install -B -pl object,hdfview -DskipTests -Ddependency-check.skip=true
            mvn package -DskipTests -B

        - name: Prepare jpackage Input Directory
          run: |
            echo "Preparing jpackage input directory..."
            JPACKAGE_INPUT=hdfview/target/jpackage-input
            rm -rf $JPACKAGE_INPUT
            mkdir -p $JPACKAGE_INPUT

            # Copy JARs
            if ls libs/hdfview-*.jar 1> /dev/null 2>&1; then
              cp libs/hdfview-*.jar $JPACKAGE_INPUT/
            elif ls hdfview/target/hdfview-*.jar 1> /dev/null 2>&1; then
              cp hdfview/target/hdfview-*.jar $JPACKAGE_INPUT/
            else
              echo "ERROR: hdfview JAR not found!"
              exit 1
            fi

            if ls libs/object-*.jar 1> /dev/null 2>&1; then
              cp libs/object-*.jar $JPACKAGE_INPUT/
            elif ls object/target/object-*.jar 1> /dev/null 2>&1; then
              cp object/target/object-*.jar $JPACKAGE_INPUT/
            else
              echo "ERROR: object JAR not found!"
              exit 1
            fi

            [ -d hdfview/target/lib ] && cp hdfview/target/lib/*.jar $JPACKAGE_INPUT/ 2>/dev/null || true
            cp -L ${{ env.HDF5LIB_PATH }}/lib/*.dylib $JPACKAGE_INPUT/ 2>/dev/null || true
            cp -L ${{ env.HDF5LIB_PATH }}/lib/*.jar $JPACKAGE_INPUT/ 2>/dev/null || true
            cp -L ${{ env.HDF4LIB_PATH }}/lib/*.dylib $JPACKAGE_INPUT/ 2>/dev/null || true
            cp -L ${{ env.HDF4LIB_PATH }}/lib/*.jar $JPACKAGE_INPUT/ 2>/dev/null || true

            mkdir -p $JPACKAGE_INPUT/plugin
            cp -L ${{ env.HDF5LIB_PATH }}/lib/plugin/*.dylib $JPACKAGE_INPUT/plugin/ 2>/dev/null || true

            echo "JAR count: $(find $JPACKAGE_INPUT -name '*.jar' | wc -l)"
            echo "Dylib count: $(find $JPACKAGE_INPUT -name '*.dylib' | wc -l)"

        - name: Setup Keychain for Code Signing
          if: github.repository == 'HDFGroup/hdfview' && env.APPLE_CERTS_BASE64 != ''
          run: |
            echo "Setting up temporary keychain for code signing..."
            CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
            KEYCHAIN_FILE=$KEYCHAIN_NAME.keychain

            echo $APPLE_CERTS_BASE64 | base64 --decode > $CERTIFICATE_PATH

            security -v create-keychain -p $KEYCHAIN_PASSWD $KEYCHAIN_FILE
            security -v list-keychain -d user -s $KEYCHAIN_FILE
            security -v list-keychains
            security -v set-keychain-settings -lut 21600 $KEYCHAIN_FILE
            security -v unlock-keychain -p $KEYCHAIN_PASSWD $KEYCHAIN_FILE

            security -v import $CERTIFICATE_PATH -P $APPLE_CERTS_BASE64_PASSWD -A -t cert -f pkcs12 -k $KEYCHAIN_FILE
            security -v set-key-partition-list -S apple-tool:,codesign:,apple: -k $KEYCHAIN_PASSWD $KEYCHAIN_FILE

            rm $CERTIFICATE_PATH

            echo "✓ Keychain setup complete"
            echo "✓ Code signing identity: $SIGNER"

        - name: Create App Image with Code Signing
          run: |
            echo "Creating ${{ matrix.arch }} app-image..."
            mkdir -p hdfview/target/dist
            MAIN_JAR=$(basename hdfview/target/jpackage-input/hdfview-*.jar)

            # Build jpackage command with conditional signing
            JPACKAGE_CMD="$JAVA_HOME/bin/jpackage \
              --verbose \
              --name HDFView \
              --input hdfview/target/jpackage-input \
              --main-jar \"$MAIN_JAR\" \
              --main-class hdf.view.HDFView \
              --dest hdfview/target/dist \
              --type app-image \
              --app-version ${{ steps.get-version.outputs.HDFVIEW_VERSION }} \
              --mac-package-identifier HDFView.hdfgroup.org \
              --mac-entitlements lib/macosx/distribution.entitlements \
              --mac-package-name HDFView-${{ steps.get-version.outputs.HDFVIEW_VERSION }} \
              --file-associations ${{ github.workspace }}/package_files/HDFViewHDF.properties \
              --file-associations ${{ github.workspace }}/package_files/HDFViewH4.properties \
              --file-associations ${{ github.workspace }}/package_files/HDFViewHDF4.properties \
              --file-associations ${{ github.workspace }}/package_files/HDFViewH5.properties \
              --file-associations ${{ github.workspace }}/package_files/HDFViewHDF5.properties"

            # Add signing options if on canonical repo with secrets
            if [ "${{ github.repository }}" = "HDFGroup/hdfview" ] && [ -n "$APPLE_CERTS_BASE64" ]; then
              echo "Adding code signing to jpackage..."
              JPACKAGE_CMD="$JPACKAGE_CMD \
                --mac-sign \
                --mac-signing-key-user-name \"The HDF Group ($SIGNER)\""
            else
              echo "Skipping code signing (fork or missing secrets)"
            fi

            eval $JPACKAGE_CMD

            echo "✓ ${{ matrix.arch }} app-image created"

        - name: Additional Code Signing (dylibs and frameworks)
          if: github.repository == 'HDFGroup/hdfview' && env.APPLE_CERTS_BASE64 != ''
          run: |
            echo "Performing bottom-up code signing of all binaries..."
            security unlock-keychain -p $KEYCHAIN_PASSWD $KEYCHAIN_NAME.keychain

            # Sign all dylib files
            echo "Signing all dylib files..."
            find hdfview/target/dist/HDFView.app -name "*.dylib" -type f | while read dylib; do
              echo "  Signing: $dylib"
              codesign --force --sign "The HDF Group ($SIGNER)" \
                --options runtime \
                --timestamp \
                "$dylib" || echo "  Warning: Failed to sign $dylib"
            done

            # Sign all framework bundles
            echo "Signing frameworks..."
            find hdfview/target/dist/HDFView.app/Contents/runtime -name "*.framework" -type d | while read framework; do
              echo "  Signing: $framework"
              codesign --force --sign "The HDF Group ($SIGNER)" \
                --options runtime \
                --timestamp \
                "$framework" || echo "  Warning: Failed to sign $framework"
            done

            # Sign executables in MacOS directory
            echo "Signing executables..."
            find hdfview/target/dist/HDFView.app/Contents/MacOS -type f -perm +111 | while read exe; do
              echo "  Signing: $exe"
              codesign --force --sign "The HDF Group ($SIGNER)" \
                --options runtime \
                --timestamp \
                "$exe" || echo "  Warning: Failed to sign $exe"
            done

            # Sign Java runtime executables
            if [ -d hdfview/target/dist/HDFView.app/Contents/runtime/Contents/Home/bin ]; then
              echo "Signing JRE binaries..."
              find hdfview/target/dist/HDFView.app/Contents/runtime/Contents/Home/bin -type f -perm +111 | while read exe; do
                echo "  Signing: $exe"
                codesign --force --sign "The HDF Group ($SIGNER)" \
                  --options runtime \
                  --timestamp \
                  "$exe" || echo "  Warning: Failed to sign $exe"
              done
            fi

            # Finally, sign the app bundle itself
            echo "Signing main app bundle..."
            codesign --force --sign "The HDF Group ($SIGNER)" \
              --options runtime \
              --timestamp \
              hdfview/target/dist/HDFView.app

            echo "✓ Bottom-up code signing complete"

            # Verify signature
            echo "Verifying app signature..."
            codesign -vvv --strict hdfview/target/dist/HDFView.app

        - name: Create Application Archive
          run: |
            cd hdfview/target/dist
            tar -czf ${{ github.workspace }}/HDFView-${{ matrix.arch }}.app.tar.gz HDFView.app/
            echo "Created ${{ matrix.arch }} archive"

        - name: Upload App Artifact
          uses: actions/upload-artifact@v4
          with:
            name: macos-app-${{ matrix.arch }}
            path: HDFView-${{ matrix.arch }}.app.tar.gz
            retention-days: 30

        - name: Create DMG Installer
          run: |
            echo "Creating DMG installer for ${{ matrix.arch }}..."
            cd hdfview/target/dist

            $JAVA_HOME/bin/jpackage \
              --type dmg \
              --app-image HDFView.app \
              --name HDFView-${{ matrix.arch }} \
              --app-version ${{ steps.get-version.outputs.HDFVIEW_VERSION }} \
              --mac-package-identifier HDFView.hdfgroup.org \
              --mac-package-name "${{ inputs.artifact_basename }}-${{ matrix.arch }}" \
              --dest .

            echo "✓ DMG installer created"
            ls -lh *.dmg

        - name: Notarize DMG Installer
          if: github.repository == 'HDFGroup/hdfview' && env.APPLE_CERTS_BASE64 != ''
          run: |
            echo "Submitting DMG for notarization..."
            cd hdfview/target/dist

            DMG_FILE="HDFView-${{ matrix.arch }}-${{ steps.get-version.outputs.HDFVIEW_VERSION }}.dmg"
            echo "DMG file: $DMG_FILE"

            xcrun notarytool submit "$DMG_FILE" \
              --apple-id "$NOTARY_USER" \
              --password "$NOTARY_KEY" \
              --team-id "$SIGNER" \
              --wait \
              --timeout 30m \
              --output-format json > notarization-response.json

            cat notarization-response.json

            STATUS=$(cat notarization-response.json | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
            SUBMISSION_ID=$(cat notarization-response.json | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4)

            echo "Notarization status: $STATUS"
            echo "Submission ID: $SUBMISSION_ID"

            if [ "$STATUS" = "Accepted" ]; then
              echo "✓ Notarization successful"
            else
              echo "✗ Notarization failed with status: $STATUS"
              if [ -n "$SUBMISSION_ID" ]; then
                xcrun notarytool log "$SUBMISSION_ID" \
                  --apple-id "$NOTARY_USER" \
                  --password "$NOTARY_KEY" \
                  --team-id "$SIGNER" || echo "Failed to fetch log"
              fi
              exit 1
            fi

        - name: Staple Notarization to DMG
          if: github.repository == 'HDFGroup/hdfview' && env.APPLE_CERTS_BASE64 != ''
          run: |
            echo "Stapling notarization ticket to DMG..."
            cd hdfview/target/dist

            DMG_FILE="HDFView-${{ matrix.arch }}-${{ steps.get-version.outputs.HDFVIEW_VERSION }}.dmg"

            xcrun stapler staple "$DMG_FILE"
            xcrun stapler validate "$DMG_FILE"

            echo "✓ Notarization ticket stapled successfully"

        - name: Upload DMG Installer Artifact
          uses: actions/upload-artifact@v4
          with:
            name: ${{ inputs.artifact_basename }}-macOS-${{ matrix.arch }}-dmg
            path: hdfview/target/dist/*.dmg
            retention-days: 30
    