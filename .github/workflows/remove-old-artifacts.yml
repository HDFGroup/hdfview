name: hdfview remove old artifacts

# This workflow removes old snapshot artifacts from GitHub releases to prevent accumulation.
# It deletes the previous build's files (based on file_base) from the specified release tag.
# This is typically called by daily-build.yml to clean up old snapshots before uploading new ones.

# Triggers the workflow on a call from another workflow
on:
  workflow_call:
    inputs:
      use_tag:
        description: 'Release version tag'
        type: string
        required: false
        default: HDFView-99.99.99
      use_environ:
        description: 'Environment to locate files'
        type: string
        required: true
        default: snapshots
      file_base:
        description: "The common base name of the source tarballs"
        required: true
        type: string

# Minimal permissions to be inherited by any job that doesn't declare its own permissions
permissions:
  contents: read

# Previous workflows must pass to get here so tag the commit that created the files
jobs:
  PreRelease-delfiles:
    runs-on: ubuntu-latest
    environment: ${{ inputs.use_environ }}
    permissions:
        contents: write
    steps:
      # Checkout repository to read VERSION file
      - name: Get Sources
        uses: actions/checkout@9a9194f87191a7e9055e3e9b95b8cfb13023bb08 # v4.1.7
        with:
          fetch-depth: 0
          ref: '${{ github.head_ref || github.ref_name }}'

      - name: Get file base name and version
        id: get-file-base
        run: |
          FILE_NAME_BASE=$(echo "${{ inputs.file_base }}")
          echo "FILE_BASE=$FILE_NAME_BASE" >> $GITHUB_OUTPUT
          # Read HDFVIEW_VERSION from VERSION file (same as maven-build.yml)
          HDFVIEW_VERSION=$(grep "^HDFVIEW_VERSION=" VERSION | cut -d'=' -f2)
          echo "VERSION=$HDFVIEW_VERSION" >> $GITHUB_OUTPUT
          echo "File base: $FILE_NAME_BASE"
          echo "HDFView version: $HDFVIEW_VERSION"

      - name: PreRelease delete from tag
        id: delete_prerelease
        if: ${{ (inputs.use_environ == 'snapshots') }}
        uses: mknejp/delete-release-assets@v1
        with:
          token: ${{ github.token }}
          tag: "${{ inputs.use_tag }}"
          assets: |
              ${{ steps.get-file-base.outputs.FILE_BASE }}.sha256sums.txt
              ${{ steps.get-file-base.outputs.FILE_BASE }}.tar.gz
              ${{ steps.get-file-base.outputs.FILE_BASE }}.zip
              ${{ steps.get-file-base.outputs.FILE_BASE }}-Linux-x86_64.tar.gz
              HDFView-${{ steps.get-file-base.outputs.VERSION }}.msi
              HDFView-${{ steps.get-file-base.outputs.VERSION }}.dmg
              ${{ steps.get-file-base.outputs.FILE_BASE }}App-Linux-x86_64.tar.gz
              ${{ steps.get-file-base.outputs.FILE_BASE }}App-win64.zip
              ${{ steps.get-file-base.outputs.FILE_BASE }}App-Darwin.tar.gz
