name: Test HDFView Release - Linux

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'HDFView release tag (e.g., HDFView-3.4.0, snapshot)'
        type: string
        required: true
        default: 'snapshot'
  workflow_call:
    inputs:
      release_tag:
        description: 'HDFView release tag (e.g., HDFView-3.4.0, snapshot)'
        type: string
        required: true

permissions:
  contents: read

jobs:
  test-app-binary:
    name: Test App Binary (tar.gz)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Download app binary from release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Downloading HDFView app binary from release: ${{ inputs.release_tag }}"
          gh release download ${{ inputs.release_tag }} \
            --repo HDFGroup/hdfview \
            --pattern "HDFView-*App-Linux.tar.gz"

          echo "Downloaded files:"
          ls -lh HDFView-*.tar.gz

      - name: Extract app binary
        run: |
          echo "Extracting app binary..."
          tar -xzf HDFView-*App-Linux.tar.gz

          echo "App structure:"
          ls -lR HDFView/

      - name: Setup Xvfb and GTK
        run: |
          echo "Installing Xvfb and GTK for headless testing..."
          sudo apt-get update
          sudo apt-get install -y xvfb libgtk-3-0

      - name: Run smoke test (launch app verification)
        run: |
          echo "Running smoke test: Launch HDFView and verify stability"

          echo "Starting Xvfb..."
          Xvfb :99 -screen 0 1024x768x24 &
          XVFB_PID=$!
          export DISPLAY=:99
          sleep 2

          echo "Attempting to launch HDFView..."

          # Find the launcher script
          if [ -f "HDFView/bin/HDFView" ]; then
            LAUNCHER="HDFView/bin/HDFView"
          else
            echo "✗ HDFView launcher not found at HDFView/bin/HDFView"
            kill $XVFB_PID 2>/dev/null || true
            exit 1
          fi

          echo "Found launcher at: $LAUNCHER"

          # Launch HDFView and let it run for 5 seconds, then kill it
          # If it crashes immediately, this will fail
          timeout 10s $LAUNCHER &
          APP_PID=$!
          sleep 5

          # Check if process is still running
          if ps -p $APP_PID > /dev/null 2>&1; then
            echo "✓ HDFView launched successfully and is running"
            kill $APP_PID 2>/dev/null || true
          else
            echo "✗ HDFView crashed or exited immediately"
            kill $XVFB_PID 2>/dev/null || true
            exit 1
          fi

          # Cleanup
          kill $XVFB_PID 2>/dev/null || true
          echo "✓ App binary smoke test PASSED"

      - name: Test Summary
        if: always()
        run: |
          echo "## App Binary Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Tag**: ${{ inputs.release_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Test**: Launch verification (5 second stability check)" >> $GITHUB_STEP_SUMMARY
          echo "- **Display**: Xvfb :99" >> $GITHUB_STEP_SUMMARY

  test-deb-installer:
    name: Test DEB Installer
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Download DEB installer
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "Downloading DEB installer from release: ${{ inputs.release_tag }}"
          gh release download ${{ inputs.release_tag }} \
            --repo HDFGroup/hdfview \
            --pattern "HDFView-*-Linux.deb"

          echo "Downloaded installer:"
          ls -lh HDFView-*.deb

      - name: Install DEB package
        run: |
          echo "Creating directory for xdg-desktop-menu"
          mkdir /usr/share/desktop-directories

          echo "Installing DEB package..."
          sudo dpkg -i HDFView-*-Linux.deb || sudo apt-get install -f -y

          echo "Verifying installation..."
          dpkg -l | grep -i hdfview || echo "Package listing check"

      - name: Setup Xvfb
        run: |
          echo "Installing Xvfb and GTK for headless testing..."
          sudo apt-get update
          sudo apt-get install -y xvfb libgtk-3-0

      - name: Verify installed application launches
        run: |
          echo "Starting Xvfb..."
          Xvfb :99 -screen 0 1024x768x24 &
          XVFB_PID=$!
          export DISPLAY=:99
          sleep 2

          echo "Attempting to launch installed HDFView..."

          # Try to find the installed launcher
          if [ -f "/opt/HDFView/bin/HDFView" ]; then
            LAUNCHER="/opt/HDFView/bin/HDFView"
          elif [ -f "/usr/bin/HDFView" ]; then
            LAUNCHER="/usr/bin/HDFView"
          else
            echo "Finding HDFView launcher..."
            LAUNCHER=$(find /opt /usr -name "HDFView" -type f 2>/dev/null | grep -i hdfview | head -1)
          fi

          if [ -z "$LAUNCHER" ]; then
            echo "✗ HDFView launcher not found after installation"
            kill $XVFB_PID 2>/dev/null || true
            exit 1
          fi

          echo "Found launcher at: $LAUNCHER"

          # Launch HDFView and let it run for 5 seconds, then kill it
          # If it crashes immediately, this will fail
          timeout 10s $LAUNCHER &
          APP_PID=$!
          sleep 5

          # Check if process is still running
          if ps -p $APP_PID > /dev/null 2>&1; then
            echo "✓ HDFView launched successfully and is running"
            kill $APP_PID 2>/dev/null || true
          else
            echo "✗ HDFView crashed or exited immediately"
            kill $XVFB_PID 2>/dev/null || true
            exit 1
          fi

          # Cleanup
          kill $XVFB_PID 2>/dev/null || true
          echo "✓ DEB installer smoke test PASSED"

      - name: Test Summary
        if: always()
        run: |
          echo "## DEB Installer Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Tag**: ${{ inputs.release_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Test**: Launch verification (5 second stability check)" >> $GITHUB_STEP_SUMMARY
          echo "- **Display**: Xvfb :99" >> $GITHUB_STEP_SUMMARY
