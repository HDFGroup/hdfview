name: Maven Release and Artifacts

on:
  push:
    tags:
      - 'v*.*.*'
      - 'release-*'
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'snapshot'
        type: choice
        options:
          - snapshot
          - release
          - hotfix
      create_github_release:
        description: 'Create GitHub release'
        required: false
        default: true
        type: boolean

permissions:
  contents: write
  packages: write
  actions: read
  security-events: write

env:
  MAVEN_OPTS: >-
    -Xmx4g
    -Xms2g
    -XX:+UseParallelGC
    -Djava.awt.headless=true

jobs:
  prepare-release:
    name: Prepare Release Artifacts
    runs-on: ubuntu-latest
    timeout-minutes: 30

    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      is_release: ${{ steps.version.outputs.is_release }}

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Cache Maven Dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-release-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-

    - name: Cache HDF Libraries
      id: cache-hdf
      uses: actions/cache@v4
      with:
        path: |
          ${{ github.workspace }}/hdf4
          ${{ github.workspace }}/hdf5
        key: ${{ runner.os }}-hdf-github-${{ github.run_id }}
        restore-keys: |
          ${{ runner.os }}-hdf-github-

    - name: Download and Install HDF4 from GitHub
      if: steps.cache-hdf.outputs.cache-hit != 'true'
      run: |
        echo "Downloading HDF4 from GitHub releases..."
        gh release download snapshot \
          --repo HDFGroup/hdf4 \
          --pattern "hdf4-master-*-ubuntu-2404_gcc.tar.gz"

        echo "Extracting HDF4..."
        tar -zxf hdf4-master-*-ubuntu-2404_gcc.tar.gz
        cd hdf4
        tar -zxf HDF-*-Linux.tar.gz --strip-components 1

        HDF4DIR=${{ github.workspace }}/hdf4/HDF_Group/HDF/
        FILE_NAME_HDF=$(ls $HDF4DIR | head -1)
        echo "HDF4LIB_PATH=$HDF4DIR$FILE_NAME_HDF" >> $GITHUB_ENV
        echo "HDF4 installed to: $HDF4DIR$FILE_NAME_HDF"
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Download and Install HDF5 from GitHub
      if: steps.cache-hdf.outputs.cache-hit != 'true'
      run: |
        echo "Downloading HDF5 from GitHub releases..."
        gh release download snapshot \
          --repo HDFGroup/hdf5 \
          --pattern "hdf5-develop-*-ubuntu-2404_gcc.tar.gz"

        echo "Extracting HDF5..."
        tar -zxf hdf5-develop-*-ubuntu-2404_gcc.tar.gz
        cd hdf5

        HDF5_TARBALL=$(ls HDF5-*-Linux.tar.gz | head -1)
        echo "Extracting $HDF5_TARBALL..."
        tar -zxf "$HDF5_TARBALL" --strip-components 1

        HDF5DIR=${{ github.workspace }}/hdf5/HDF_Group/HDF5/
        FILE_NAME_HDF5=$(ls $HDF5DIR | head -1)
        echo "HDF5LIB_PATH=$HDF5DIR$FILE_NAME_HDF5" >> $GITHUB_ENV
        echo "HDF5 installed to: $HDF5DIR$FILE_NAME_HDF5"
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Set Environment Variables from Cache
      if: steps.cache-hdf.outputs.cache-hit == 'true'
      run: |
        HDF4DIR=${{ github.workspace }}/hdf4/HDF_Group/HDF/
        FILE_NAME_HDF=$(ls $HDF4DIR | head -1)
        echo "HDF4LIB_PATH=$HDF4DIR$FILE_NAME_HDF" >> $GITHUB_ENV

        HDF5DIR=${{ github.workspace }}/hdf5/HDF_Group/HDF5/
        FILE_NAME_HDF5=$(ls $HDF5DIR | head -1)
        echo "HDF5LIB_PATH=$HDF5DIR$FILE_NAME_HDF5" >> $GITHUB_ENV

        echo "Using cached HDF libraries:"
        echo "HDF4: $HDF4DIR$FILE_NAME_HDF"
        echo "HDF5: $HDF5DIR$FILE_NAME_HDF5"

    - name: Install Java Dependencies to Maven Local Repository
      run: |
        echo "Installing Java dependencies from GitHub downloads..."

        # Copy HDF JARs from downloaded GitHub distributions
        mkdir -p repository/lib
        cp ${{ env.HDF4LIB_PATH }}/lib/*.jar repository/lib/ 2>/dev/null || echo "No HDF4 JARs found"
        cp ${{ env.HDF5LIB_PATH }}/lib/*.jar repository/lib/ 2>/dev/null || echo "No HDF5 JARs found"

        # Install fits.jar and netcdf.jar
        mvn install:install-file -Dfile=repository/lib/fits.jar \
          -DgroupId=fits -DartifactId=fits -Dversion=1.0.0 \
          -Dpackaging=jar -DgeneratePom=true

        mvn install:install-file -Dfile=repository/lib/netcdf.jar \
          -DgroupId=netcdf -DartifactId=netcdf -Dversion=1.0.0 \
          -Dpackaging=jar -DgeneratePom=true

        # Install jarhdf5
        if [ -f repository/lib/jarhdf5-*.jar ]; then
          JAR_FILE=$(ls repository/lib/jarhdf5-*.jar | head -1)
          mvn install:install-file -Dfile="$JAR_FILE" \
            -DgroupId=jarhdf5 -DartifactId=jarhdf5 -Dversion=2.0.0 \
            -Dpackaging=jar -DgeneratePom=true
          echo "Installed: $JAR_FILE"
        fi

        # Install jarhdf
        if [ -f repository/lib/jarhdf-*.jar ]; then
          JAR_FILE=$(ls repository/lib/jarhdf-*.jar | head -1)
          mvn install:install-file -Dfile="$JAR_FILE" \
            -DgroupId=jarhdf -DartifactId=jarhdf -Dversion=4.3.1 \
            -Dpackaging=jar -DgeneratePom=true
          echo "Installed: $JAR_FILE"
        fi

        # Install SWTBot JARs
        mvn install:install-file -Dfile=repository/lib/org.eclipse.swtbot.swt.finder.jar \
          -DgroupId=org.eclipse.local -DartifactId=org.eclipse.swtbot.swt.finder -Dversion=4.2.1 \
          -Dpackaging=jar -DgeneratePom=true

        mvn install:install-file -Dfile=repository/lib/org.eclipse.swtbot.nebula.nattable.finder.jar \
          -DgroupId=org.eclipse.local -DartifactId=org.eclipse.swtbot.nebula.nattable.finder -Dversion=4.2.1 \
          -Dpackaging=jar -DgeneratePom=true

        echo "All Java dependencies installed successfully"

    - name: Set up build.properties
      run: |
        cat > build.properties << EOF
        # Release Build Properties for HDFView
        # Using HDF libraries from GitHub releases

        # HDF5 Configuration
        hdf5.lib.dir=${{ env.HDF5LIB_PATH }}/lib
        hdf5.plugin.dir=${{ env.HDF5LIB_PATH }}/lib/plugin

        # HDF4 Configuration
        hdf.lib.dir=${{ env.HDF4LIB_PATH }}/lib

        # Platform Configuration
        platform.hdf.lib=${{ env.HDF5LIB_PATH }}/lib

        # Build flags
        ci.build=true
        release.build=true
        EOF

        echo "Generated build.properties for Release:"
        cat build.properties

        # Set LD_LIBRARY_PATH for test execution
        echo "LD_LIBRARY_PATH=${{ env.HDF5LIB_PATH }}/lib:${{ env.HDF4LIB_PATH }}/lib" >> $GITHUB_ENV

    - name: Determine Version and Release Type
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          IS_RELEASE=true
        elif [[ "${{ github.event.inputs.release_type }}" == "release" ]]; then
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout | sed 's/-SNAPSHOT//')
          TAG="v${VERSION}"
          IS_RELEASE=true
        else
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          TAG="snapshot-$(date +%Y%m%d-%H%M%S)"
          IS_RELEASE=false
        fi

        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "tag=${TAG}" >> $GITHUB_OUTPUT
        echo "is_release=${IS_RELEASE}" >> $GITHUB_OUTPUT

        echo "Determined version: ${VERSION}"
        echo "Tag: ${TAG}"
        echo "Is release: ${IS_RELEASE}"

    - name: Build and Install Modules
      run: |
        echo "::group::Build and Install Dependencies"
        # Install parent POM first (required for properties plugin)
        mvn install -B -N -Ddependency-check.skip=true

        # Compile repository module
        mvn compile -pl repository -B -Ddependency-check.skip=true

        # Install object and hdfview modules
        mvn install -pl object,hdfview -DskipTests -Ddependency-check.skip=true -B
        echo "::endgroup::"

    - name: Run Quality Checks
      run: |
        echo "::group::Quality Validation for Release"

        # Run tests (object module only - 149 tests)
        # UI tests disabled in CI - require real display
        mvn test -B -pl object -Dmaven.test.failure.ignore=false

        # Run quality analysis (object module only)
        mvn jacoco:prepare-agent test jacoco:report -B -pl object

        # Check coverage threshold for release (object module only)
        if [[ "${{ steps.version.outputs.is_release }}" == "true" ]]; then
          mvn jacoco:check -Djacoco.haltOnFailure=true -pl object
        fi

        echo "::endgroup::"

    - name: Build Release Artifacts
      run: |
        echo "::group::Build Release Artifacts"

        # Clean build with all artifacts
        mvn clean package -B \
          -DskipTests \
          -Dmaven.javadoc.skip=false \
          -Dmaven.source.skip=false

        # Create distribution packages
        mvn assembly:single -B -DskipTests || echo "Assembly plugin not configured"

        echo "::endgroup::"

    - name: Generate Release Notes
      id: release-notes
      run: |
        echo "::group::Generate Release Notes"

        RELEASE_NOTES_FILE="release-notes-${{ steps.version.outputs.version }}.md"

        cat > "${RELEASE_NOTES_FILE}" << EOF
        # HDFView Release ${{ steps.version.outputs.version }}

        **Release Date**: $(date '+%Y-%m-%d')
        **Build**: ${{ github.run_number }}
        **Commit**: ${{ github.sha }}

        ## ðŸ“¦ Artifacts

        ### Application JARs
        EOF

        # List main artifacts
        find . -name "*.jar" -not -path "*/target/lib/*" -not -name "*-tests.jar" | \
          grep -E "(hdfview|object)" | \
          sort | \
          sed 's/^/- `/' | sed 's/$/`/' >> "${RELEASE_NOTES_FILE}"

        cat >> "${RELEASE_NOTES_FILE}" << EOF

        ### Dependencies
        - Java 21+ required
        - HDF5 native libraries required
        - HDF4 native libraries (optional)

        ## ðŸ”§ Installation

        1. Download the appropriate JAR files
        2. Ensure HDF5 native libraries are installed
        3. Run with: \`java -jar hdfview-${{ steps.version.outputs.version }}.jar\`

        ## ðŸ“‹ Build Information

        - **Maven Version**: $(mvn --version | head -n1)
        - **Java Version**: $(java -version 2>&1 | head -n1)
        - **Platform**: Ubuntu Latest (GitHub Actions)

        ## ðŸ” Quality Metrics

        EOF

        # Add coverage information if available
        if [ -f target/site/jacoco/index.html ]; then
          COVERAGE=$(grep -o 'Total[^%]*%' target/site/jacoco/index.html | grep -o '[0-9]*%' | head -1)
          echo "- **Code Coverage**: ${COVERAGE:-Unknown}" >> "${RELEASE_NOTES_FILE}"
        fi

        echo "release_notes_file=${RELEASE_NOTES_FILE}" >> $GITHUB_OUTPUT
        echo "::endgroup::"

    - name: Upload Release Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: release-artifacts-${{ steps.version.outputs.version }}
        path: |
          libs/*.jar
          target/*.jar
          hdfview/target/*.jar
          object/target/*.jar
          !**/*-tests.jar
          !**/original-*.jar
        retention-days: 90

    - name: Upload Release Documentation
      uses: actions/upload-artifact@v4
      with:
        name: release-documentation-${{ steps.version.outputs.version }}
        path: |
          target/site/apidocs/
          ${{ steps.release-notes.outputs.release_notes_file }}
        retention-days: 90

  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: prepare-release
    if: needs.prepare-release.outputs.is_release == 'true' && (github.event.inputs.create_github_release == 'true' || github.event_name == 'push')

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Download Release Artifacts
      uses: actions/download-artifact@v4
      with:
        name: release-artifacts-${{ needs.prepare-release.outputs.version }}
        path: ./release-artifacts

    - name: Download Release Documentation
      uses: actions/download-artifact@v4
      with:
        name: release-documentation-${{ needs.prepare-release.outputs.version }}
        path: ./release-docs

    - name: Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ needs.prepare-release.outputs.tag }}
        release_name: HDFView ${{ needs.prepare-release.outputs.version }}
        body_path: ./release-docs/release-notes-${{ needs.prepare-release.outputs.version }}.md
        draft: false
        prerelease: ${{ contains(needs.prepare-release.outputs.version, '-') }}

    - name: Upload Release Assets
      run: |
        # Upload main JAR files to the release
        for jar_file in release-artifacts/*.jar; do
          if [ -f "$jar_file" ]; then
            echo "Uploading: $(basename "$jar_file")"
            gh release upload ${{ needs.prepare-release.outputs.tag }} "$jar_file"
          fi
        done
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-packages:
    name: Publish Maven Packages
    runs-on: ubuntu-latest
    needs: prepare-release
    if: needs.prepare-release.outputs.is_release == 'true'

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Cache Maven Dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-publish-${{ hashFiles('**/pom.xml') }}

    - name: Install HDF Libraries
      run: |
        sudo apt-get update
        sudo apt-get install -y libhdf5-dev libhdf4-dev

        # Try to install Java packages if available (may not exist in all Ubuntu versions)
        sudo apt-get install -y libhdf5-java || echo "libhdf5-java not available, will use GitHub releases"
        sudo apt-get install -y libhdf4-java || echo "libhdf4-java not available, will use GitHub releases"

    - name: Install Java Dependencies to Maven Local Repository
      run: |
        echo "Installing Java dependencies..."

        # Install fits.jar and netcdf.jar from repository
        mvn install:install-file -Dfile=repository/lib/fits.jar \
          -DgroupId=fits -DartifactId=fits -Dversion=1.0.0 \
          -Dpackaging=jar -DgeneratePom=true

        mvn install:install-file -Dfile=repository/lib/netcdf.jar \
          -DgroupId=netcdf -DartifactId=netcdf -Dversion=1.0.0 \
          -Dpackaging=jar -DgeneratePom=true

        # Install HDF JARs - try system packages first, fallback to downloading
        # Note: libhdf4-java and libhdf5-java may not be available in all Ubuntu versions
        echo "Checking for HDF Java packages..."

        # Always download jarhdf5 from GitHub (system packages are outdated)
        echo "Downloading jarhdf5.jar from GitHub..."
        mkdir -p /tmp/hdf5-download && cd /tmp/hdf5-download
          gh release download snapshot --repo HDFGroup/hdf5 --pattern "*ubuntu-2404_gcc.tar.gz"
          tar -zxf hdf5-*-ubuntu-2404_gcc.tar.gz
          cd hdf5

          # Extract inner tar.gz
          HDF5_TARBALL=$(ls HDF5-*-Linux.tar.gz | head -1)
          tar -zxf "$HDF5_TARBALL" --strip-components 1

          # Find JAR in HDF_Group/HDF5/version/lib structure
          if [ -d HDF_Group/HDF5 ]; then
            VERSION_DIR=$(ls HDF_Group/HDF5 | head -1)
            JAR_FILE=$(ls HDF_Group/HDF5/$VERSION_DIR/lib/jarhdf5*.jar 2>/dev/null | head -1)
            if [ -f "$JAR_FILE" ]; then
              mvn install:install-file -Dfile="$JAR_FILE" \
                -DgroupId=jarhdf5 -DartifactId=jarhdf5 -Dversion=2.0.0 \
                -Dpackaging=jar -DgeneratePom=true
              echo "Installed jarhdf5.jar from GitHub: $JAR_FILE"
            fi
          fi
          cd ${{ github.workspace }}

        # Try jarhdf from system packages, fallback to GitHub download
        if [ -f /usr/share/java/jarhdf.jar ]; then
          echo "Installing jarhdf.jar from system packages"
          mvn install:install-file -Dfile=/usr/share/java/jarhdf.jar \
            -DgroupId=jarhdf -DartifactId=jarhdf -Dversion=4.3.1 \
            -Dpackaging=jar -DgeneratePom=true
        else
          echo "System packages don't provide jarhdf.jar, downloading from GitHub..."
          mkdir -p /tmp/hdf4-download && cd /tmp/hdf4-download
          gh release download snapshot --repo HDFGroup/hdf4 --pattern "*ubuntu-2404_gcc.tar.gz"
          tar -zxf hdf4-*-ubuntu-2404_gcc.tar.gz
          cd hdf4

          # Extract inner tar.gz
          HDF4_TARBALL=$(ls HDF-*-Linux.tar.gz | head -1)
          tar -zxf "$HDF4_TARBALL" --strip-components 1

          # Find JAR in HDF_Group/HDF/version/lib structure
          if [ -d HDF_Group/HDF ]; then
            VERSION_DIR=$(ls HDF_Group/HDF | head -1)
            JAR_FILE=$(ls HDF_Group/HDF/$VERSION_DIR/lib/jarhdf-*.jar 2>/dev/null | head -1)
            if [ -f "$JAR_FILE" ]; then
              mvn install:install-file -Dfile="$JAR_FILE" \
                -DgroupId=jarhdf -DartifactId=jarhdf -Dversion=4.3.1 \
                -Dpackaging=jar -DgeneratePom=true
              echo "Installed jarhdf.jar from GitHub: $JAR_FILE"
            fi
          fi
          cd ${{ github.workspace }}
        fi

        # Install SWTBot JARs for UI testing
        mvn install:install-file -Dfile=repository/lib/org.eclipse.swtbot.swt.finder.jar \
          -DgroupId=org.eclipse.local -DartifactId=org.eclipse.swtbot.swt.finder -Dversion=4.2.1 \
          -Dpackaging=jar -DgeneratePom=true

        mvn install:install-file -Dfile=repository/lib/org.eclipse.swtbot.nebula.nattable.finder.jar \
          -DgroupId=org.eclipse.local -DartifactId=org.eclipse.swtbot.nebula.nattable.finder -Dversion=4.2.1 \
          -Dpackaging=jar -DgeneratePom=true

        echo "All Java dependencies installed successfully"
      env:
        GH_TOKEN: ${{ github.token }}

    - name: Set up build.properties
      run: |
        cat > build.properties << EOF
        hdf5.lib.dir=/usr/lib/x86_64-linux-gnu
        hdf.lib.dir=/usr/lib/x86_64-linux-gnu
        platform.hdf.lib=/usr/lib/x86_64-linux-gnu
        ci.build=true
        release.build=true
        EOF

    - name: Configure Maven Settings
      run: |
        mkdir -p ~/.m2
        cat > ~/.m2/settings.xml << EOF
        <settings>
          <servers>
            <server>
              <id>github</id>
              <username>\${env.GITHUB_ACTOR}</username>
              <password>\${env.GITHUB_TOKEN}</password>
            </server>
          </servers>
        </settings>
        EOF

    - name: Publish to GitHub Packages
      run: |
        mvn deploy -B \
          -DskipTests \
          -Dmaven.javadoc.skip=false \
          -Dmaven.source.skip=false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}