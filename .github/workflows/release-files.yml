name: hdfview release-files

# Triggers the workflow on a call from another workflow
on:
  workflow_call:
    inputs:
      release_version_tag:
        description: 'Git tag name to create'
        type: string
        required: false
        default: HDFView-99.99.99
      build_environment:
        description: 'Environment to locate files'
        type: string
        required: true
        default: snapshots
      artifact_basename:
        description: "Base name for all build artifacts (e.g., hdfview-master-abc1234 or HDFView-3.4.0)"
        required: true
        type: string
      file_branch:
        description: "The branch name for the source tarballs"
        required: true
        type: string
      file_sha:
        description: "The sha for the source tarballs"
        required: true
        type: string

# Minimal permissions to be inherited by any job that doesn't declare its own permissions
permissions:
  contents: read

# Previous workflows must pass to get here so tag the commit that created the files
jobs:
  create-tag:
    runs-on: ubuntu-latest
    permissions:
        contents: write # In order to allow tag creation
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Get Sources
        uses: actions/checkout@9a9194f87191a7e9055e3e9b95b8cfb13023bb08 # v4.1.7
        with:
          fetch-depth: 0
          ref: '${{ github.head_ref || github.ref_name }}'

      - uses: rickstaa/action-create-tag@a1c7777fcb2fee4f19b0f283ba888afa11678b72 # v1.7.2
        id: "tag_create"
        with:
          commit_sha: ${{ inputs.file_sha }}
          tag: "${{ inputs.release_version_tag }}"
          force_push_tag: false
          tag_exists_error: false
          message: "Latest snapshot"

      # Print result using the action output.
      - run: |
          echo "Tag already present: ${{ steps.tag_create.outputs.tag_exists }}"

  PreRelease-getfiles:
    runs-on: ubuntu-latest
    needs: create-tag
    environment: ${{ inputs.build_environment }}
    permissions:
        contents: write
    steps:
      # Checkout repository to read VERSION file
      - name: Get Sources
        uses: actions/checkout@9a9194f87191a7e9055e3e9b95b8cfb13023bb08 # v4.1.7
        with:
          fetch-depth: 0
          ref: '${{ github.head_ref || github.ref_name }}'

      - name: Get artifact basename and version
        id: get-artifact-info
        run: |
          ARTIFACT_NAME=$(echo "${{ inputs.artifact_basename }}")
          echo "ARTIFACT_BASENAME=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
          # Read HDFVIEW_VERSION from VERSION file (same as maven-build.yml)
          HDFVIEW_VERSION=$(grep "^HDFVIEW_VERSION=" VERSION | cut -d'=' -f2)
          echo "VERSION=$HDFVIEW_VERSION" >> $GITHUB_OUTPUT
          echo "Artifact basename: $ARTIFACT_NAME"
          echo "HDFView version: $HDFVIEW_VERSION"

      # Get files created by tarball script
      - name: Get tgz-tarball (Linux)
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
              name: tgz-tarball
              path: ${{ github.workspace }}

      - name: Get zip-tarball (Windows)
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
              name: zip-tarball
              path: ${{ github.workspace }}

      # Get platform installers created by jpackage (REQUIRED)
      # Snapshots: {artifact_basename}-win64-msi (includes commit SHA)
      # Releases: HDFView-{VERSION}-win64-msi (version only)
      - name: Get Windows MSI installer
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
              name: ${{ inputs.build_environment == 'snapshots' && format('{0}-win64-msi', steps.get-artifact-info.outputs.ARTIFACT_BASENAME) || format('HDFView-{0}-win64-msi', steps.get-artifact-info.outputs.VERSION) }}
              path: ${{ github.workspace }}

      - name: Get macOS DMG installer
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
              name: ${{ inputs.build_environment == 'snapshots' && format('{0}-macOS-dmg', steps.get-artifact-info.outputs.ARTIFACT_BASENAME) || format('HDFView-{0}-macOS-dmg', steps.get-artifact-info.outputs.VERSION) }}
              path: ${{ github.workspace }}

      - name: Get DEB installer (Linux)
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
              name: deb-ubuntu-2404-installer
              path: ${{ github.workspace }}

      - name: Get RPM installer (Linux)
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
              name: rpm-ubuntu-2404-installer
              path: ${{ github.workspace }}

      # Get files created by ant-app script
      - name: Get published app binary (Windows)
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
              name: zip-win-vs2022-app-binary
              path: ${{ github.workspace }}
      
      - name: Get published app binary (MacOS)
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
              name: tgz-macos14_clang-app-binary
              path: ${{ github.workspace }}
      
      - name: Get published app binary (Linux)
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
              name: tgz-ubuntu-2404-app-binary
              path: ${{ github.workspace }}

      # Get files created by tarball script
      - name: Get UsersGuide (Linux)
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
              name: docs-usersguide
              path: ${{ github.workspace }}/UsersGuide

      - name: Create snapshot source file (tgz and zip)
        id: create-release-files
        run: |
              zip -r UsersGuide.zip ./UsersGuide
              tar -zcvf UsersGuide.tar.gz ./UsersGuide
        shell: bash

      - name: List downloaded files (debug)
        run: |
          echo "=== Files in workspace ==="
          ls -lh
          echo ""
          echo "=== Checking for installer files ==="
          # Snapshots: {artifact_basename}.msi, Releases: HDFView-{VERSION}.msi
          if [ "${{ inputs.build_environment }}" = "snapshots" ]; then
            ls -lh ${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}.msi || echo "MSI not found!"
            ls -lh ${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}.dmg || echo "DMG not found!"
          else
            ls -lh HDFView-${{ steps.get-artifact-info.outputs.VERSION }}.msi || echo "MSI not found!"
            ls -lh HDFView-${{ steps.get-artifact-info.outputs.VERSION }}.dmg || echo "DMG not found!"
          fi

      - name: Create sha256 sums for files
        run: |
          sha256sum ${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}.tar.gz >${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}.sha256sums.txt
          sha256sum ${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}.zip >>${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}.sha256sums.txt
          # DEB and RPM packages for Linux
          sha256sum *.deb >>${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}.sha256sums.txt
          sha256sum *.rpm >>${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}.sha256sums.txt
          # Snapshots: {artifact_basename}.msi/dmg, Releases: HDFView-{VERSION}.msi/dmg
          if [ "${{ inputs.build_environment }}" = "snapshots" ]; then
            sha256sum ${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}.msi >>${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}.sha256sums.txt
            sha256sum ${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}.dmg >>${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}.sha256sums.txt
          else
            sha256sum HDFView-${{ steps.get-artifact-info.outputs.VERSION }}.msi >>${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}.sha256sums.txt
            sha256sum HDFView-${{ steps.get-artifact-info.outputs.VERSION }}.dmg >>${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}.sha256sums.txt
          fi
          sha256sum ${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}App-Linux-x86_64.tar.gz >>${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}.sha256sums.txt
          sha256sum ${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}App-win64.zip >>${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}.sha256sums.txt
          sha256sum ${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}App-Darwin.tar.gz >>${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}.sha256sums.txt
          sha256sum UsersGuide.tar.gz >> ${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}.sha256sums.txt
          sha256sum UsersGuide.zip >> ${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}.sha256sums.txt

      - name: Store snapshot name
        run: |
          echo "${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}" > ./last-file.txt

      - name: Get NEWSLETTER
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
              name: NEWSLETTER
              path: ${{ github.workspace }}

      - name: Create description file
        run: |
          cat ${{ github.workspace }}/CHANGELOG.md > description.txt

      - name: PreRelease tag
        id: create_prerelease
        if: ${{ (inputs.build_environment == 'snapshots') }}
        uses: softprops/action-gh-release@v2.2.2
        with:
          tag_name: "${{ inputs.release_version_tag }}"
          prerelease: true
          make_latest: false
          body_path: description.txt
          files: |
              last-file.txt
              UsersGuide.tar.gz
              UsersGuide.zip
              ${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}.tar.gz
              ${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}.zip
              *.deb
              *.rpm
              ${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}.msi
              ${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}.dmg
              ${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}App-Linux-x86_64.tar.gz
              ${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}App-win64.zip
              ${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}App-Darwin.tar.gz
              ${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}.sha256sums.txt
              if-no-files-found: error # 'warn' or 'ignore' are also available, defaults to `warn`

      - name: Release tag
        id: create_release
        if: ${{ (inputs.build_environment == 'release') }}
        uses: softprops/action-gh-release@v2.2.2
        with:
          tag_name: "${{ inputs.release_version_tag }}"
          prerelease: false
          make_latest: true
          body_path: description.txt
          files: |
              UsersGuide.tar.gz
              UsersGuide.zip
              ${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}.tar.gz
              ${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}.zip
              *.deb
              *.rpm
              HDFView-${{ steps.get-artifact-info.outputs.VERSION }}.msi
              HDFView-${{ steps.get-artifact-info.outputs.VERSION }}.dmg
              ${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}App-Linux-x86_64.tar.gz
              ${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}App-win64.zip
              ${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}App-Darwin.tar.gz
              ${{ steps.get-artifact-info.outputs.ARTIFACT_BASENAME }}.sha256sums.txt
              if-no-files-found: error # 'warn' or 'ignore' are also available, defaults to `warn`
